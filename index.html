<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafetyIQ - Intelligent Safety Analytics</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #0A1628;
            --secondary: #1E3A5F;
            --accent: #00D4AA;
            --accent-hover: #00F5C4;
            --warning: #FF6B35;
            --danger: #E63946;
            --success: #2ECC71;
            --surface: #0F1D32;
            --surface-elevated: #162A46;
            --text-primary: #FFFFFF;
            --text-secondary: #8BA3C7;
            --text-muted: #5A7299;
            --border: #2A4066;
            --exxon-red: #E21836;
            --gradient-accent: linear-gradient(135deg, #00D4AA 0%, #00A3FF 100%);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Instrument Sans', -apple-system, sans-serif;
            background: var(--primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 170, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 163, 255, 0.06) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
        }

        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(42, 64, 102, 0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(42, 64, 102, 0.07) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none; z-index: 0;
        }

        /* WELL HEADER */
        .well-header {
            position: relative; z-index: 2;
            background: linear-gradient(180deg, rgba(15, 29, 50, 0.95), rgba(10, 22, 40, 0.9));
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            backdrop-filter: blur(10px);
        }
        .well-header-inner {
            max-width: 600px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between; gap: 12px;
        }
        .well-info { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .well-name { font-size: 15px; font-weight: 700; color: var(--text-primary); }
        .well-location { font-size: 12px; color: var(--text-secondary); }
        .exxon-logo-text { font-size: 18px; font-weight: 800; color: #E21836; letter-spacing: -0.5px; font-family: Arial Black, Arial, sans-serif; flex-shrink: 0; }
        .siq-badge {
            width: 30px; height: 30px;
            background: var(--gradient-accent); border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 10px; color: var(--primary);
            flex-shrink: 0; letter-spacing: 0.3px;
        }
        .settings-gear {
            width: 32px; height: 32px; border: none;
            background: rgba(255,255,255,0.06); border-radius: 8px;
            color: var(--text-secondary); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: all 0.2s;
        }
        .settings-gear:hover { background: rgba(255,255,255,0.1); color: var(--accent); }

        /* LOGIN SCREEN */
        .login-screen {
            position: relative; z-index: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: calc(100vh - 65px); min-height: calc(100dvh - 65px);
            padding: 20px;
        }
        .login-screen.hidden { display: none; }

        .login-card { width: 100%; max-width: 440px; text-align: center; }
        .exxon-hero {
            font-family: Arial Black, Arial, sans-serif;
            font-size: 36px; font-weight: 900; color: #E21836;
            letter-spacing: -0.5px; margin-bottom: 12px;
        }
        .login-title { font-size: 22px; font-weight: 600; margin-bottom: 4px; color: var(--text-secondary); }
        .login-subtitle { color: var(--text-secondary); margin-bottom: 36px; font-size: 14px; }

        /* 4 MAIN BUTTONS */
        .main-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 28px; }
        .action-btn {
            position: relative;
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px 16px 22px; cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            overflow: hidden;
        }
        .action-btn::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 3px; border-radius: 3px 3px 0 0; opacity: 0; transition: opacity 0.25s;
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .action-btn:hover::before { opacity: 1; }
        .action-btn:active { transform: translateY(0); }
        .action-btn .icon-wrap {
            width: 52px; height: 52px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .action-btn svg { width: 26px; height: 26px; }
        .action-btn h4 { font-size: 15px; font-weight: 600; }
        .action-btn p { font-size: 12px; color: var(--text-secondary); }

        .action-btn.checkin { border-color: rgba(0, 212, 170, 0.25); }
        .action-btn.checkin::before { background: var(--gradient-accent); }
        .action-btn.checkin .icon-wrap { background: rgba(0, 212, 170, 0.12); color: var(--accent); }
        .action-btn.checkin:hover { border-color: rgba(0, 212, 170, 0.5); background: rgba(0, 212, 170, 0.05); }

        .action-btn.checkout { border-color: rgba(255, 107, 53, 0.25); }
        .action-btn.checkout::before { background: linear-gradient(135deg, #FF6B35, #FF4444); }
        .action-btn.checkout .icon-wrap { background: rgba(255, 107, 53, 0.12); color: var(--warning); }
        .action-btn.checkout:hover { border-color: rgba(255, 107, 53, 0.5); background: rgba(255, 107, 53, 0.05); }

        .action-btn.meeting { border-color: rgba(0, 163, 255, 0.25); }
        .action-btn.meeting::before { background: linear-gradient(135deg, #0088FF, #00A3FF); }
        .action-btn.meeting .icon-wrap { background: rgba(0, 163, 255, 0.12); color: #00A3FF; }
        .action-btn.meeting:hover { border-color: rgba(0, 163, 255, 0.5); background: rgba(0, 163, 255, 0.05); }

        .action-btn.newuser { border-color: rgba(156, 120, 255, 0.25); }
        .action-btn.newuser::before { background: linear-gradient(135deg, #9C78FF, #B388FF); }
        .action-btn.newuser .icon-wrap { background: rgba(156, 120, 255, 0.12); color: #B388FF; }
        .action-btn.newuser:hover { border-color: rgba(156, 120, 255, 0.5); background: rgba(156, 120, 255, 0.05); }

        .dev-bypass { margin-top: 8px; text-align: center; }
        .dev-bypass button {
            background: none; border: 1px dashed rgba(255,255,255,0.1);
            color: var(--text-muted); font-size: 11px; padding: 6px 16px;
            border-radius: var(--radius-sm); cursor: pointer;
            font-family: 'JetBrains Mono', monospace; transition: all 0.2s;
        }
        .dev-bypass button:hover { border-color: var(--accent); color: var(--accent); }

        .status-bar { margin-top: 20px; text-align: center; }
        .status-count {
            font-family: 'JetBrains Mono', monospace; font-size: 12px;
            color: var(--text-muted);
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .status-dot {
            width: 6px; height: 6px; background: var(--accent);
            border-radius: 50%; animation: blink 2s infinite;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        /* LEVEL UP OVERLAY */
        .levelup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none; display: none;
        }
        .levelup-overlay.active { display: block; pointer-events: all; }
        .levelup-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0); transition: background 0.4s ease;
        }
        .levelup-overlay.active .levelup-bg { background: rgba(0, 0, 0, 0.88); }
        .levelup-content {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            text-align: center; opacity: 0;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .levelup-overlay.active .levelup-content {
            transform: translate(-50%, -50%) scale(1); opacity: 1;
        }
        .levelup-overlay.float-up .levelup-content {
            transform: translate(-50%, -150%) scale(0.8); opacity: 0;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .levelup-icon {
            width: 100px; height: 100px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 24px; position: relative;
        }
        .levelup-icon svg { width: 48px; height: 48px; }
        .levelup-icon.ci { background: rgba(0, 212, 170, 0.2); color: var(--accent); box-shadow: 0 0 60px rgba(0, 212, 170, 0.4), 0 0 120px rgba(0, 212, 170, 0.15); }
        .levelup-icon.co { background: rgba(255, 107, 53, 0.2); color: var(--warning); box-shadow: 0 0 60px rgba(255, 107, 53, 0.4), 0 0 120px rgba(255, 107, 53, 0.15); }

        .levelup-ring {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            border-radius: 50%; border: 2px solid currentColor; opacity: 0;
        }
        .levelup-overlay.active .levelup-ring { animation: ringPulse 1s ease-out forwards; }
        .levelup-overlay.active .levelup-ring:nth-child(2) { animation-delay: 0.15s; }
        .levelup-overlay.active .levelup-ring:nth-child(3) { animation-delay: 0.3s; }
        @keyframes ringPulse {
            0% { width: 100px; height: 100px; opacity: 0.8; }
            100% { width: 240px; height: 240px; opacity: 0; }
        }

        .levelup-text { font-size: 36px; font-weight: 700; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 8px; }
        .levelup-text.ci { color: var(--accent); text-shadow: 0 0 30px rgba(0, 212, 170, 0.6); }
        .levelup-text.co { color: var(--warning); text-shadow: 0 0 30px rgba(255, 107, 53, 0.6); }
        .levelup-name { font-size: 18px; color: var(--text-secondary); font-weight: 500; }
        .levelup-time { font-family: 'JetBrains Mono', monospace; font-size: 14px; color: var(--text-muted); margin-top: 8px; }
        .particle { position: absolute; border-radius: 50%; pointer-events: none; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000;
            display: none; align-items: center; justify-content: center;
            padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: var(--radius-lg); width: 100%; max-width: 480px;
            max-height: 90vh; overflow-y: auto; padding: 28px;
            animation: modalIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalIn { from { opacity: 0; transform: translateY(20px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal h3 { font-size: 20px; font-weight: 700; margin-bottom: 20px; }

        /* FORM */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input, .form-select {
            width: 100%; padding: 12px 16px;
            background: var(--surface-elevated); border: 1px solid var(--border);
            border-radius: var(--radius-sm); color: var(--text-primary);
            font-family: inherit; font-size: 14px; transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* BUTTONS */
        .btn {
            padding: 12px 20px; border: none; border-radius: var(--radius-sm);
            font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--gradient-accent); color: var(--primary); }
        .btn-primary:hover { box-shadow: 0 0 20px rgba(0, 212, 170, 0.3); }
        .btn-secondary { background: var(--surface-elevated); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-block { width: 100%; }
        .btn-danger { background: var(--danger); color: white; }

        /* CAMERA */
        .camera-container { width: 100%; aspect-ratio: 4/3; background: var(--primary); border-radius: var(--radius-md); overflow: hidden; position: relative; margin-bottom: 12px; }
        .camera-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; color: var(--text-muted); }
        .camera-placeholder svg { width: 48px; height: 48px; }
        .camera-container video, .camera-container img { width: 100%; height: 100%; object-fit: cover; }
        .camera-controls { position: absolute; bottom: 12px; left: 0; right: 0; display: flex; justify-content: center; }
        .camera-btn { width: 56px; height: 56px; border-radius: 50%; border: 3px solid white; background: rgba(0, 212, 170, 0.8); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* QR */
        .qr-display { text-align: center; padding: 20px; }
        .qr-code { display: inline-block; padding: 16px; background: white; border-radius: var(--radius-md); margin-bottom: 16px; }

        /* TOAST */
        .toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 10000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 24px; border-radius: var(--radius-sm); font-size: 14px; font-weight: 500; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; white-space: nowrap; }
        .toast.success { background: var(--accent); color: var(--primary); }
        .toast.error { background: var(--danger); color: white; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }

        /* SETTINGS */
        .settings-section { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h4 { font-size: 14px; color: var(--accent); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }

        /* USER LIST */
        .user-select-list { max-height: 280px; overflow-y: auto; }
        .user-select-item {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border: 1px solid var(--border); border-radius: var(--radius-sm);
            margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .user-select-item:hover { border-color: var(--accent); background: rgba(0, 212, 170, 0.05); }

        .signin-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
        .signin-option { background: var(--surface-elevated); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px 16px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .signin-option:hover { border-color: var(--accent); }
        .signin-option svg { width: 32px; height: 32px; color: var(--accent); margin-bottom: 8px; }
        .signin-option h4 { font-size: 14px; margin-bottom: 4px; }
        .signin-option p { font-size: 12px; color: var(--text-secondary); }

        .divider { text-align: center; color: var(--text-muted); font-size: 12px; margin: 16px 0; display: flex; align-items: center; gap: 12px; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

        /* DASHBOARD */
        .app-container { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
        .app-container.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; margin-bottom: 24px; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 12px; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo-icon { width: 44px; height: 44px; background: var(--gradient-accent); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: var(--primary); }
        .logo-text h2 { font-size: 18px; font-weight: 700; }
        .logo-text span { font-size: 12px; color: var(--text-secondary); }

        .back-btn { background: none; border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 16px; border-radius: var(--radius-sm); cursor: pointer; font-family: inherit; font-size: 13px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .back-btn:hover { border-color: var(--accent); color: var(--accent); }

        .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        .card-header h3 { font-size: 16px; font-weight: 700; }
        .card-header svg { width: 20px; height: 20px; color: var(--accent); }

        .attendees-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .attendee-card { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--surface-elevated); border-radius: var(--radius-sm); }
        .attendee-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 13px; flex-shrink: 0; overflow: hidden; }
        .attendee-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .attendee-name { font-size: 13px; font-weight: 600; }
        .attendee-role { font-size: 11px; color: var(--text-secondary); }
        .attendee-time { font-size: 10px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .attendee-status { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 4px; margin-top: 2px; display: inline-block; }
        .attendee-status.in { background: rgba(0, 212, 170, 0.15); color: var(--accent); }
        .attendee-add { border: 1px dashed var(--border); background: transparent; cursor: pointer; justify-content: center; gap: 6px; color: var(--text-muted); font-size: 13px; transition: all 0.2s; }
        .attendee-add:hover { border-color: var(--accent); color: var(--accent); }

        .meeting-setup { display: grid; gap: 16px; }
        .start-meeting-btn { width: 100%; padding: 16px; background: var(--gradient-accent); border: none; border-radius: var(--radius-md); color: var(--primary); font-family: inherit; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .start-meeting-btn:hover { box-shadow: 0 0 30px rgba(0, 212, 170, 0.3); }
        .start-meeting-btn svg { width: 24px; height: 24px; }

        @media (max-width: 480px) {
            .well-header { padding: 10px 16px; }
            .well-name { font-size: 13px; }
            .login-screen { padding: 16px; }
            .main-actions { gap: 10px; }
            .action-btn { padding: 22px 12px 18px; }
            .action-btn .icon-wrap { width: 44px; height: 44px; }
            .action-btn svg { width: 22px; height: 22px; }
            .levelup-text { font-size: 28px; letter-spacing: 3px; }
            .modal { padding: 20px; }
        }
        @media (min-width: 768px) { .dashboard-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div class="grid-overlay"></div>

    <!-- WELL HEADER -->
    <div class="well-header">
        <div class="well-header-inner">
            <div class="well-info">
                <div class="well-name" id="wellNameDisplay">Justin SWD #1</div>
                <div class="well-location" id="wellLocationDisplay">McKenzie County, ND</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <button class="settings-gear" onclick="openSettings()" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
                <div class="siq-badge">SIQ</div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="exxon-hero">ExxonMobil</div>
            <h1 class="login-title">SafetyIQ</h1>
            <p class="login-subtitle">Intelligent Safety Analytics Platform</p>
            <div class="main-actions">
                <div class="action-btn checkin" onclick="showCheckIn()">
                    <div class="icon-wrap"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"/></svg></div>
                    <h4>Check In</h4><p>Arriving on location</p>
                </div>
                <div class="action-btn checkout" onclick="showCheckOut()">
                    <div class="icon-wrap"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></div>
                    <h4>Check Out</h4><p>Leaving location</p>
                </div>
                <div class="action-btn meeting" onclick="holdMeeting()">
                    <div class="icon-wrap"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg></div>
                    <h4>Hold Meeting</h4><p>Safety meeting</p>
                </div>
                <div class="action-btn newuser" onclick="showVisitorSignIn()">
                    <div class="icon-wrap"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1zm13-8h4m-2-2v4"/></svg></div>
                    <h4>Visitor</h4><p>Guest check in</p>
                </div>
            </div>
            <div class="status-bar"><div class="status-count"><span class="status-dot"></span><span id="checkedInCount">0</span> on location</div></div>
            <div class="dev-bypass"><button onclick="devBypass()">âš¡ dev bypass</button></div>
        </div>
    </div>

    <!-- MAIN APP DASHBOARD -->
    <div class="app-container" id="mainApp">
        <header class="header">
            <div class="logo"><div class="logo-icon">SIQ</div><div class="logo-text"><h2>SafetyIQ</h2><span>Dashboard</span></div></div>
            <button class="back-btn" onclick="backToLogin()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg> Back
            </button>
        </header>
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <h3>On Location (<span id="attendeeCount">0</span>)</h3>
                </div>
                <div class="attendees-grid" id="attendeesGrid">
                    <div class="attendee-card attendee-add" onclick="openSignInModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Add Attendee</div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                    <h3>Meeting Setup</h3>
                </div>
                <div class="meeting-setup">
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Well / Site</label><input type="text" class="form-input" id="wellInput" placeholder="e.g. Justin SWD #1"></div>
                        <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="locationInput" placeholder="e.g. McKenzie County, ND"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Job Scope</label>
                        <select class="form-select" id="jobScopeSelect">
                            <option value="">Select scope...</option>
                            <option value="Pre-Job Safety Meeting">Pre-Job Safety Meeting</option>
                            <option value="Daily Safety Meeting">Daily Safety Meeting</option>
                            <option value="Tailgate Meeting">Tailgate Meeting</option>
                            <option value="JSA Review">JSA Review</option>
                            <option value="Emergency Drill">Emergency Drill</option>
                            <option value="Workover Operations">Workover Operations</option>
                            <option value="Plug & Abandon">Plug & Abandon</option>
                            <option value="Well Intervention">Well Intervention</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="meetingNotes" rows="3" placeholder="Additional notes..." style="resize:vertical;"></textarea></div>
                    <button class="start-meeting-btn" onclick="startMeeting()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Start Recording Meeting
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LEVEL UP OVERLAY -->
    <div class="levelup-overlay" id="levelupOverlay">
        <div class="levelup-bg"></div>
        <div class="levelup-content">
            <div class="levelup-icon" id="levelupIcon">
                <div class="levelup-ring"></div><div class="levelup-ring"></div><div class="levelup-ring"></div>
                <svg id="levelupSvg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"></svg>
            </div>
            <div class="levelup-text" id="levelupText"></div>
            <div class="levelup-name" id="levelupName"></div>
            <div class="levelup-time" id="levelupTime"></div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay"><div class="modal"><div id="modalBody"></div></div></div>

    <!-- TOAST -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    const state = {
        users: JSON.parse(localStorage.getItem('registeredUsers') || '[]'),
        checkedIn: JSON.parse(localStorage.getItem('checkedInUsers') || '[]'),
        settings: JSON.parse(localStorage.getItem('siqSettings') || '{}'),
    };
    let profileStream = null, capturedPhotoData = null;

    function init() { applySettings(); updateStatusCount(); }

    function applySettings() {
        const s = state.settings;
        if (s.wellName) document.getElementById('wellNameDisplay').textContent = s.wellName;
        if (s.wellLocation) document.getElementById('wellLocationDisplay').textContent = s.wellLocation;
    }

    function updateStatusCount() {
        document.getElementById('checkedInCount').textContent = state.checkedIn.filter(c => !c.checkoutTime).length;
    }

    // === LEVEL UP ===
    function showLevelUp(type, name) {
        const o = document.getElementById('levelupOverlay');
        const icon = document.getElementById('levelupIcon');
        const svg = document.getElementById('levelupSvg');
        const text = document.getElementById('levelupText');
        const now = new Date();
        const t = now.toLocaleTimeString('en-US', {hour:'2-digit',minute:'2-digit'});

        if (type === 'checkin') {
            icon.className = 'levelup-icon ci';
            svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>';
            text.className = 'levelup-text ci'; text.textContent = 'CHECKED IN';
            spawnParticles('#00D4AA');
        } else {
            icon.className = 'levelup-icon co';
            svg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"/>';
            text.className = 'levelup-text co'; text.textContent = 'CHECKED OUT';
            spawnParticles('#FF6B35');
        }
        document.getElementById('levelupName').textContent = name;
        document.getElementById('levelupTime').textContent = t;

        o.classList.remove('float-up'); o.classList.add('active');
        setTimeout(() => o.classList.add('float-up'), 1800);
        setTimeout(() => o.classList.remove('active', 'float-up'), 3200);
    }

    function spawnParticles(color) {
        const o = document.getElementById('levelupOverlay');
        for (let i = 0; i < 24; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            const a = (Math.PI * 2 / 24) * i + (Math.random() - 0.5) * 0.5;
            const d = 80 + Math.random() * 180;
            const s = 3 + Math.random() * 5;
            p.style.cssText = `width:${s}px;height:${s}px;background:${color};left:50%;top:50%;transform:translate(-50%,-50%);opacity:1;transition:all ${0.5+Math.random()*0.6}s cubic-bezier(0.16,1,0.3,1);box-shadow:0 0 ${s*2}px ${color};`;
            o.appendChild(p);
            requestAnimationFrame(() => {
                p.style.transform = `translate(calc(-50% + ${Math.cos(a)*d}px), calc(-50% + ${Math.sin(a)*d}px))`;
                p.style.opacity = '0';
            });
            setTimeout(() => p.remove(), 1500);
        }
    }

    // === CHECK IN ===
    function showCheckIn() {
        if (!state.users.length) { showToast('No crew registered yet. Use settings or dev bypass to add crew.', 'error'); return; }
        const avail = state.users.filter(u => !state.checkedIn.find(c => c.user.id === u.id && !c.checkoutTime));
        if (!avail.length) { showToast('Everyone is already checked in!', 'error'); return; }
        document.getElementById('modalBody').innerHTML = `
            <h3>Check In</h3>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Select who is arriving on location</p>
            <div class="user-select-list">${avail.map(u => `
                <div class="user-select-item" onclick="doCheckIn('${u.id}')">
                    <div class="attendee-avatar">${u.photo ? `<img src="${u.photo}">` : u.name.charAt(0)}</div>
                    <div><div class="attendee-name">${u.name}</div><div class="attendee-role">${u.position} â€” ${u.company}</div></div>
                </div>`).join('')}
            </div>
            <div style="margin-top:16px;"><button class="btn btn-secondary btn-block" onclick="closeModal()">Cancel</button></div>`;
        openModal();
    }

    function doCheckIn(id) {
        const u = state.users.find(x => x.id === id); if (!u) return;
        state.checkedIn.push({ user: u, checkinTime: new Date().toISOString(), checkoutTime: null });
        localStorage.setItem('checkedInUsers', JSON.stringify(state.checkedIn));
        closeModal(); updateStatusCount(); showLevelUp('checkin', u.name);
    }

    // === CHECK OUT ===
    function showCheckOut() {
        const on = state.checkedIn.filter(c => !c.checkoutTime);
        if (!on.length) { showToast('No one is currently checked in.', 'error'); return; }
        document.getElementById('modalBody').innerHTML = `
            <h3>Check Out</h3>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">Select who is leaving location</p>
            <div class="user-select-list">${on.map((c,i) => `
                <div class="user-select-item" onclick="doCheckOut(${i})">
                    <div class="attendee-avatar">${c.user.photo ? `<img src="${c.user.photo}">` : c.user.name.charAt(0)}</div>
                    <div><div class="attendee-name">${c.user.name}</div><div class="attendee-role">${c.user.position} â€” ${c.user.company}</div>
                    <div class="attendee-time">In since ${new Date(c.checkinTime).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</div></div>
                </div>`).join('')}
            </div>
            <div style="margin-top:16px;"><button class="btn btn-secondary btn-block" onclick="closeModal()">Cancel</button></div>`;
        openModal();
    }

    function doCheckOut(idx) {
        const on = state.checkedIn.filter(c => !c.checkoutTime);
        const rec = on[idx]; if (!rec) return;
        const mi = state.checkedIn.indexOf(rec);
        if (mi >= 0) state.checkedIn[mi].checkoutTime = new Date().toISOString();
        localStorage.setItem('checkedInUsers', JSON.stringify(state.checkedIn));
        closeModal(); updateStatusCount(); showLevelUp('checkout', rec.user.name);
    }

    // === HOLD MEETING ===
    function holdMeeting() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.add('active');
        const s = state.settings;
        if (s.wellName) document.getElementById('wellInput').value = s.wellName;
        if (s.wellLocation) document.getElementById('locationInput').value = s.wellLocation;
        renderAttendees();
    }

    function backToLogin() {
        document.getElementById('mainApp').classList.remove('active');
        document.getElementById('loginScreen').classList.remove('hidden');
        updateStatusCount();
    }

    // === NEW USER ===
    function showVisitorSignIn() {
        capturedPhotoData = null;
        document.getElementById('modalBody').innerHTML = `
            <h3>Visitor Check In</h3>
            <p style="color:var(--text-secondary);font-size:13px;margin-bottom:16px;">For guests and visitors â€” core crew should use Check In with their ID</p>
            <div class="camera-container" id="profileCameraContainer">
                <div class="camera-placeholder" id="profilePlaceholder">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:48px;height:48px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Take photo (optional)</span>
                </div>
                <video id="profileVideo" autoplay playsinline style="display:none;"></video>
                <img id="capturedPhoto" style="display:none;width:100%;height:100%;object-fit:cover;">
                <div class="camera-controls" id="cameraControls" style="display:none;">
                    <button class="camera-btn" onclick="capturePhoto()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg></button>
                </div>
            </div>
            <button class="btn btn-secondary btn-block" onclick="startProfileCamera()" id="startCameraBtn">ðŸ“· Start Camera</button>
            <div style="margin-top:20px;">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Full Name *</label><input type="text" class="form-input" id="visitorName" placeholder="John Smith"></div>
                    <div class="form-group"><label class="form-label">Company *</label><input type="text" class="form-input" id="visitorCompany" placeholder="Halliburton"></div>
                </div>
                <div class="form-group"><label class="form-label">Purpose of Visit *</label>
                    <select class="form-select" id="visitorPurpose">
                        <option value="">Select purpose...</option>
                        <option value="Delivery">Delivery</option>
                        <option value="Inspection">Inspection</option>
                        <option value="Regulatory Visit">Regulatory Visit</option>
                        <option value="Vendor Service">Vendor Service</option>
                        <option value="Consulting">Consulting</option>
                        <option value="Training">Training</option>
                        <option value="Management Visit">Management Visit</option>
                        <option value="Contractor">Contractor</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:12px;margin-top:16px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="flex:1;" onclick="registerVisitor()">Check In Visitor</button>
            </div>`;
        openModal();
    }

    function registerVisitor() {
        const n = document.getElementById('visitorName').value.trim();
        const c = document.getElementById('visitorCompany').value.trim();
        const p = document.getElementById('visitorPurpose').value;
        if (!n || !c || !p) { showToast('Fill in all required fields', 'error'); return; }
        const id = 'visitor_' + Date.now();
        const visitor = { id, name: n, company: c, position: 'Visitor â€” ' + p, photo: capturedPhotoData, isVisitor: true, registeredAt: new Date().toISOString() };
        // Add to checked-in directly (visitors auto check in)
        state.checkedIn.push({ user: visitor, checkinTime: new Date().toISOString(), checkoutTime: null });
        localStorage.setItem('checkedInUsers', JSON.stringify(state.checkedIn));
        closeModal(); updateStatusCount(); showLevelUp('checkin', n);
    }

    async function startProfileCamera() {
        try {
            profileStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            const v = document.getElementById('profileVideo'); v.srcObject = profileStream; v.style.display = 'block';
            document.getElementById('profilePlaceholder').style.display = 'none';
            document.getElementById('cameraControls').style.display = 'flex';
            document.getElementById('startCameraBtn').style.display = 'none';
        } catch(e) { showToast('Unable to access camera', 'error'); }
    }

    function capturePhoto() {
        const v = document.getElementById('profileVideo');
        const c = document.createElement('canvas'); c.width = v.videoWidth; c.height = v.videoHeight;
        c.getContext('2d').drawImage(v, 0, 0);
        capturedPhotoData = c.toDataURL('image/jpeg');
        document.getElementById('capturedPhoto').src = capturedPhotoData;
        document.getElementById('capturedPhoto').style.display = 'block';
        v.style.display = 'none';
        document.getElementById('cameraControls').innerHTML = '<button class="camera-btn" onclick="retakePhoto()" style="background:var(--warning);">â†»</button>';
        if (profileStream) profileStream.getTracks().forEach(t => t.stop());
    }

    function retakePhoto() {
        capturedPhotoData = null;
        document.getElementById('capturedPhoto').style.display = 'none';
        document.getElementById('startCameraBtn').style.display = 'block';
        document.getElementById('cameraControls').style.display = 'none';
        document.getElementById('profilePlaceholder').style.display = 'flex';
    }

    function showUserQRCode(u) {
        document.getElementById('modalBody').innerHTML = `
            <div class="qr-display"><h3 style="margin-bottom:20px;">Save Your QR Badge</h3>
            <div class="qr-code" id="userQRCode"></div>
            <p style="color:var(--text-secondary);font-size:14px;margin-top:12px;"><strong>${u.name}</strong><br>${u.position} â€” ${u.company}<br><br>Screenshot this QR code for future sign-ins!</p></div>
            <button class="btn btn-primary btn-block" onclick="closeModal()">Got It</button>`;
        openModal();
        if (typeof QRCode !== 'undefined') new QRCode(document.getElementById('userQRCode'), { text: u.qrCode, width: 168, height: 168, colorDark: '#0A1628', colorLight: '#ffffff' });
    }

    // === DEV BYPASS ===
    function devBypass() {
        if (!state.users.length) {
            state.users = [
                { id:'dev_1', name:'Jonathan Barber', company:'JB Consulting', position:'Consultant', photo:null, qrCode:'dev_1', registeredAt:new Date().toISOString() },
                { id:'dev_2', name:'Mike Henderson', company:'ExxonMobil', position:'Company Man', photo:null, qrCode:'dev_2', registeredAt:new Date().toISOString() },
                { id:'dev_3', name:'Jake Williams', company:'Halliburton', position:'Driller', photo:null, qrCode:'dev_3', registeredAt:new Date().toISOString() },
            ];
            localStorage.setItem('registeredUsers', JSON.stringify(state.users));
            showToast('Dev: 3 test users added');
        }
        holdMeeting();
    }

    // === DASHBOARD ===
    function renderAttendees() {
        const g = document.getElementById('attendeesGrid');
        const on = state.checkedIn.filter(c => !c.checkoutTime);
        g.innerHTML = on.map(c => `
            <div class="attendee-card">
                <div class="attendee-avatar">${c.user.photo ? `<img src="${c.user.photo}">` : c.user.name.charAt(0)}</div>
                <div><div class="attendee-name">${c.user.name}</div><div class="attendee-role">${c.user.position} â€” ${c.user.company}</div><span class="attendee-status in">ON LOCATION</span></div>
            </div>`).join('') + `<div class="attendee-card attendee-add" onclick="openSignInModal()"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>Add Attendee</div>`;
        document.getElementById('attendeeCount').textContent = on.length;
    }

    function openSignInModal() {
        document.getElementById('modalBody').innerHTML = `
            <h3>Add Attendee</h3>
            <div class="signin-options">
                <div class="signin-option" onclick="showQRSignIn()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg><h4>Scan QR</h4><p>Returning user</p></div>
                <div class="signin-option" onclick="closeModal();showVisitorSignIn();"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1zm13-8h4m-2-2v4"/></svg><h4>Visitor</h4><p>Guest check in</p></div>
            </div>
            <div class="divider">or select crew member</div>
            <div class="user-select-list">${state.users.map(u => `
                <div class="user-select-item" onclick="quickAddAttendee('${u.id}')">
                    <div class="attendee-avatar">${u.photo ? `<img src="${u.photo}">` : u.name.charAt(0)}</div>
                    <div><div class="attendee-name">${u.name}</div><div class="attendee-role">${u.position} â€” ${u.company}</div></div>
                </div>`).join('')}${!state.users.length ? '<p style="text-align:center;color:var(--text-muted);padding:20px;">No crew members registered</p>' : ''}
            </div>
            <div style="margin-top:16px;"><button class="btn btn-secondary btn-block" onclick="closeModal()">Cancel</button></div>`;
        openModal();
    }

    function quickAddAttendee(id) {
        const u = state.users.find(x => x.id === id); if (!u) return;
        if (state.checkedIn.find(c => c.user.id === id && !c.checkoutTime)) { showToast('Already on location', 'error'); return; }
        state.checkedIn.push({ user: u, checkinTime: new Date().toISOString(), checkoutTime: null });
        localStorage.setItem('checkedInUsers', JSON.stringify(state.checkedIn));
        closeModal(); renderAttendees(); updateStatusCount(); showToast(u.name + ' added');
    }

    function showQRSignIn() {
        document.getElementById('modalBody').innerHTML = `
            <h3>Scan QR Badge</h3>
            <div class="camera-container"><div class="camera-placeholder" id="qrPlaceholder"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:48px;height:48px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg><span>Camera initializing...</span></div><video id="qrVideo" autoplay playsinline style="display:none;"></video></div>
            <p style="text-align:center;color:var(--text-secondary);font-size:13px;">Position QR badge in front of camera</p>
            <div class="divider">or upload QR image</div>
            <input type="file" class="form-input" accept="image/*" onchange="handleQRUpload(event)" style="padding:12px;">
            <div style="margin-top:16px;"><button class="btn btn-secondary btn-block" onclick="closeModal()">Cancel</button></div>`;
        openModal();
        initQRCamera();
    }

    async function initQRCamera() {
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            const v = document.getElementById('qrVideo');
            if (v) { v.srcObject = s; v.style.display = 'block'; document.getElementById('qrPlaceholder').style.display = 'none'; }
        } catch(e) { const p = document.getElementById('qrPlaceholder'); if (p) p.innerHTML = '<span>Camera not available. Use file upload.</span>'; }
    }

    function handleQRUpload(e) {
        if (e.target.files[0]) {
            showToast('QR detected! Looking up...');
            setTimeout(() => { if (state.users.length) quickAddAttendee(state.users[0].id); else showToast('User not found.', 'error'); }, 1000);
        }
    }

    async function startMeeting() {
        const w = document.getElementById('wellInput').value.trim();
        const l = document.getElementById('locationInput').value.trim();
        const j = document.getElementById('jobScopeSelect').value;
        if (!w || !l || !j) { showToast('Please fill in well, location, and job scope', 'error'); return; }
        showToast('Meeting recording started!');
    }

    // === SETTINGS ===
    function openSettings() {
        const s = state.settings;
        document.getElementById('modalBody').innerHTML = `
            <h3>Settings</h3>
            <div class="settings-section"><h4>Crew Management</h4>
                <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">Core crew members who check in/out with IDs. Visitors use the Visitor button.</p>
                <div id="crewList" style="margin-bottom:12px;">${state.users.map((u,i) => `
                    <div style="display:flex;align-items:center;gap:10px;padding:8px;background:var(--surface-elevated);border-radius:6px;margin-bottom:6px;">
                        <div style="width:30px;height:30px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;flex-shrink:0;">${u.name.charAt(0)}</div>
                        <div style="flex:1;"><div style="font-size:13px;font-weight:600;">${u.name}</div><div style="font-size:11px;color:var(--text-secondary);">${u.position} â€” ${u.company}</div></div>
                        <button onclick="removeCrew(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:16px;">âœ•</button>
                    </div>`).join('')}${!state.users.length ? '<p style="text-align:center;color:var(--text-muted);padding:12px;">No crew added yet</p>' : ''}</div>
                <button class="btn btn-secondary btn-block" onclick="closeModal();showAddCrewModal();">+ Add Crew Member</button>
            </div>
            <div class="settings-section"><h4>Well Information</h4>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Well / Site Name</label><input type="text" class="form-input" id="settWellName" value="${s.wellName||'Justin SWD #1'}"></div>
                    <div class="form-group"><label class="form-label">Location</label><input type="text" class="form-input" id="settWellLocation" value="${s.wellLocation||'McKenzie County, ND'}"></div>
                </div>
                <div class="form-group"><label class="form-label">Operator</label><input type="text" class="form-input" id="settOperator" value="${s.operator||'ExxonMobil'}"></div>
            </div>
            <div class="settings-section"><h4>API Keys</h4>
                <div class="form-group"><label class="form-label">Gemini API Key</label><input type="password" class="form-input" id="settApiKey" value="${s.apiKey||''}" placeholder="For AI analysis"></div>
            </div>
            <div class="settings-section"><h4>Data Management</h4>
                <div style="display:flex;gap:12px;">
                    <button class="btn btn-secondary" onclick="exportData()">ðŸ“¥ Export</button>
                    <button class="btn btn-danger" onclick="clearAllData()">ðŸ—‘ï¸ Clear All</button>
                </div>
            </div>
            <div style="display:flex;gap:12px;margin-top:16px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="flex:1;" onclick="saveSettings()">Save</button>
            </div>`;
        openModal();
    }

    function showAddCrewModal() {
        capturedPhotoData = null;
        document.getElementById('modalBody').innerHTML = `
            <h3>Add Crew Member</h3>
            <div class="camera-container" id="profileCameraContainer">
                <div class="camera-placeholder" id="profilePlaceholder">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width:48px;height:48px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Take ID photo</span>
                </div>
                <video id="profileVideo" autoplay playsinline style="display:none;"></video>
                <img id="capturedPhoto" style="display:none;width:100%;height:100%;object-fit:cover;">
                <div class="camera-controls" id="cameraControls" style="display:none;">
                    <button class="camera-btn" onclick="capturePhoto()"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg></button>
                </div>
            </div>
            <button class="btn btn-secondary btn-block" onclick="startProfileCamera()" id="startCameraBtn">ðŸ“· Start Camera</button>
            <div style="margin-top:20px;">
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Full Name *</label><input type="text" class="form-input" id="crewName" placeholder="John Smith"></div>
                    <div class="form-group"><label class="form-label">Company *</label><input type="text" class="form-input" id="crewCompany" placeholder="Halliburton"></div>
                </div>
                <div class="form-group"><label class="form-label">Position / Role *</label>
                    <select class="form-select" id="crewPosition">
                        <option value="">Select position...</option>
                        <option value="Driller">Driller</option><option value="Derrickhand">Derrickhand</option>
                        <option value="Floorhand">Floorhand</option><option value="Motorhand">Motorhand</option>
                        <option value="Company Man">Company Man</option><option value="Tool Pusher">Tool Pusher</option>
                        <option value="Rig Manager">Rig Manager</option><option value="Safety Coordinator">Safety Coordinator</option>
                        <option value="Wireline Operator">Wireline Operator</option><option value="Coiled Tubing Operator">Coiled Tubing Operator</option>
                        <option value="Frac Supervisor">Frac Supervisor</option><option value="MWD/LWD">MWD/LWD</option>
                        <option value="Mud Engineer">Mud Engineer</option><option value="Cementer">Cementer</option>
                        <option value="Consultant">Consultant</option><option value="Other">Other</option>
                    </select>
                </div>
            </div>
            <div style="display:flex;gap:12px;margin-top:16px;">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" style="flex:1;" onclick="addCrewMember()">Add & Generate QR</button>
            </div>`;
        openModal();
    }

    function addCrewMember() {
        const n = document.getElementById('crewName').value.trim();
        const c = document.getElementById('crewCompany').value.trim();
        const p = document.getElementById('crewPosition').value;
        if (!n || !c || !p) { showToast('Fill in all required fields', 'error'); return; }
        const id = 'crew_' + Date.now();
        const u = { id, name: n, company: c, position: p, photo: capturedPhotoData, qrCode: id, registeredAt: new Date().toISOString() };
        state.users.push(u); localStorage.setItem('registeredUsers', JSON.stringify(state.users));
        closeModal(); showToast(n + ' added to crew!'); showUserQRCode(u);
    }

    function removeCrew(idx) {
        if (!confirm('Remove ' + state.users[idx].name + ' from crew?')) return;
        state.users.splice(idx, 1);
        localStorage.setItem('registeredUsers', JSON.stringify(state.users));
        closeModal(); openSettings(); showToast('Crew member removed');
    }

    function saveSettings() {
        state.settings = { wellName: document.getElementById('settWellName').value.trim(), wellLocation: document.getElementById('settWellLocation').value.trim(), operator: document.getElementById('settOperator').value.trim(), apiKey: document.getElementById('settApiKey').value.trim() };
        localStorage.setItem('siqSettings', JSON.stringify(state.settings));
        applySettings(); closeModal(); showToast('Settings saved!');
    }

    function clearAllData() {
        if (confirm('Clear ALL data?')) {
            localStorage.clear(); state.users=[]; state.checkedIn=[]; state.settings={};
            updateStatusCount(); applySettings(); closeModal(); showToast('All data cleared');
        }
    }

    function exportData() {
        const d = { users: state.users, checkedIn: state.checkedIn, settings: state.settings, exportedAt: new Date().toISOString() };
        const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(b);
        a.download = `safetyiq-${new Date().toISOString().split('T')[0]}.json`; a.click();
        showToast('Data exported!');
    }

    // === MODAL ===
    function openModal() { document.getElementById('modalOverlay').classList.add('active'); }
    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
        if (profileStream) { profileStream.getTracks().forEach(t => t.stop()); profileStream = null; }
        const q = document.getElementById('qrVideo'); if (q && q.srcObject) q.srcObject.getTracks().forEach(t => t.stop());
    }
    document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

    // === TOAST ===
    function showToast(msg, type='success') {
        const t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }

    init();
    </script>
</body>
</html>
